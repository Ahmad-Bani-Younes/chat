<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</title>
  <style>
    body { font-family: Arial; direction: rtl; padding: 20px; text-align: center; background: #f4f4f4; }
    .user-card { border: 1px solid #ccc; padding: 10px; margin: 10px auto; width: 300px; border-radius: 8px; background: #fff; }
    button { padding: 5px 15px; margin-top: 5px; }
    h3 { margin-top: 30px; color: #333; }
    a { text-decoration: none; color: green; }
  </style>
</head>
<body>
  <h2>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§ <span id="userName"></span></h2>
  <button onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

  <h3>ğŸ‘¥ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ù‚ØªØ±Ø­ÙˆÙ†</h3>
  <div id="userList"></div>

  <h3>ğŸ“© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</h3>
  <div id="pendingList"></div>

  <h3>âœ… Ø£ØµØ¯Ù‚Ø§Ø¤Ùƒ</h3>
<div id="friendsList"></div>


  <script>
    const api = 'https://68650ba05b5d8d03397f75b3.mockapi.io/users';
    const currentUser = JSON.parse(sessionStorage.getItem('user'));

    if (!currentUser || !currentUser.id) {
      alert("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      window.location.href = "login.html";
    }

    document.getElementById('userName').innerText = currentUser.name;

    async function loadUsers() {
      const res = await fetch(api);
      const users = await res.json();

      const myData = users.find(u => u.id === currentUser.id);
      const friends = myData.friends || [];
      const pending = myData.pendingRequests || [];

      const userList = document.getElementById('userList');
      userList.innerHTML = '';

      const pendingList = document.getElementById('pendingList');
      pendingList.innerHTML = '';

    users.forEach(user => {
  if (user.id === currentUser.id) return;

  const isFriend = friends.includes(user.id);
  const alreadySent = (user.pendingRequests || []).includes(currentUser.id);

  // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† ÙÙŠ Ù‚Ø³Ù… Ù…Ù†ÙØµÙ„
  if (isFriend) {
    const card = document.createElement('div');
    card.className = 'user-card';
    card.innerHTML = `
      <h3>${user.name}</h3>
      <p>ğŸ“ ${user.phone || '---'}</p>
      <a href="chat.html?to=${user.id}">ğŸ’¬ Ø§ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</a>
    `;
    friendsList.appendChild(card);
    return;
  }

  // ğŸ“© Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©
  if (pending.includes(user.id)) {
    const card = document.createElement('div');
    card.className = 'user-card';
    card.innerHTML = `
      <h3>${user.name}</h3>
      <p>ğŸ“ ${user.phone || '---'}</p>
      <button onclick="acceptRequest('${user.id}')">âœ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØµØ¯Ø§Ù‚Ø©</button>
    `;
    pendingList.appendChild(card);
    return;
  }

  // ğŸ‘¥ Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ù‚ØªØ±Ø­ÙŠÙ† Ø£Ùˆ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
  const card = document.createElement('div');
  card.className = 'user-card';
  card.innerHTML = `
    <h3>${user.name}</h3>
    <p>ğŸ“ ${user.phone || '---'}</p>
    ${
      alreadySent
        ? `<button disabled>ğŸ“¨ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</button>`
        : `<button onclick="sendRequest('${user.id}')">â• Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©</button>`
    }
  `;
  userList.appendChild(card);
});

    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©: Ø£Ø¶Ù Ù†ÙØ³Ùƒ Ø¥Ù„Ù‰ pendingRequests Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
    async function sendRequest(targetId) {
      const res = await fetch(`${api}/${targetId}`);
      const targetUser = await res.json();
      const updatedPending = targetUser.pendingRequests || [];

      if (!updatedPending.includes(currentUser.id)) {
        updatedPending.push(currentUser.id);
        await fetch(`${api}/${targetId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...targetUser, pendingRequests: updatedPending })
        });
        alert("ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©");
        loadUsers();
      }
    }

    // Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØµØ¯Ø§Ù‚Ø©: Ø£Ø¶Ù Ø¨Ø¹Ø¶ ÙƒØ£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† pending
    async function acceptRequest(senderId) {
      const myRes = await fetch(`${api}/${currentUser.id}`);
      const myData = await myRes.json();
      const myFriends = myData.friends || [];
      const myPending = myData.pendingRequests || [];

      if (!myFriends.includes(senderId)) myFriends.push(senderId);
      const updatedPending = myPending.filter(id => id !== senderId);

      await fetch(`${api}/${currentUser.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...myData, friends: myFriends, pendingRequests: updatedPending })
      });

      // Ø£Ø¶Ù Ø£Ù†Øª ÙƒØµØ¯ÙŠÙ‚ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£ÙŠØ¶Ù‹Ø§
      const otherRes = await fetch(`${api}/${senderId}`);
      const otherData = await otherRes.json();
      const otherFriends = otherData.friends || [];

      if (!otherFriends.includes(currentUser.id)) {
        otherFriends.push(currentUser.id);
        await fetch(`${api}/${senderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...otherData, friends: otherFriends })
        });
      }

      alert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ¯ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­");
      loadUsers();
    }

    function logout() {
      sessionStorage.removeItem('user');
      window.location.href = "login.html";
    }

    const friendsList = document.getElementById('friendsList');


    loadUsers();
  </script>
</body>
</html>
